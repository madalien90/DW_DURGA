<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DW-DURGA | Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chart-container {
      width: 300px;
      height: 300px;
      margin: 40px auto;
      border: 2px solid #333;
      border-radius: 10px;
      background-color: #1e1e1e;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }
    .chart-container-large {
      width: 400px;
      height: 400px;
      margin: 40px auto;
      border: 2px solid #333;
      border-radius: 10px;
      background-color: #1e1e1e;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .role-dropdown {
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }
    .role-dropdown:focus {
      outline: none;
    }
    .dataworx {
      background: white;
      padding: 9px;
      border-radius: 5px;
      margin-top: -2%;
    }
    .toggle-switch {
      display: inline-block;
      position: relative;
      width: 60px;
      height: 34px;
      vertical-align: middle;
    }
    .toggle-switch input[type="checkbox"] {
      display: none;
    }
    .toggle-switch label {
      position: relative;
      display: block;
      height: 100%;
      width: 100%;
      background-color: #e9ecef;
      border-radius: 34px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .toggle-switch input[type="checkbox"]:checked + label {
      background-color: #198754;
    }
    .toggle-switch label::after {
      content: '';
      position: absolute;
      width: 26px;
      height: 26px;
      left: 4px;
      top: 4px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .toggle-switch input[type="checkbox"]:checked + label::after {
      transform: translateX(26px);
    }
    .actions-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .client-btn {
      padding: 4px 10px;
      font-size: 0.875rem;
      color: azure;
    }
    .table td {
      vertical-align: middle;
    }
    .chart-text {
      color: #fff;
      text-align: center;
      font-size: 14px;
      margin-top: 6%;
    }
    .ct2 {
      color: navy;
      font-size: 18px;
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5" style="position:relative;padding-top:2.2rem !important;">
    <h3 class="d-inline-block dataworx">Welcome to Dashboard, <span id="userName" style="color:darkblue;"></span></h3>
    <button id="logoutBtn" class="btn btn-danger logout-btn">Logout</button>

    <!-- Charts for non-Super Admin users -->
    <div id="userCharts" class="row justify-content-center" style="display:none;">
      <div class="col-md-4 chart-container">
        <canvas id="schemeDistributionChart"></canvas>
        <div class="chart-text ct2">Distribution of beneficiaries (across schemes)</div>
      </div>
      <div class="col-md-4 chart-container">
        <canvas id="completionStatusChart"></canvas>
        <div class="chart-text ct2">Progress status of data collection</div>
      </div>
      <div class="col-md-4 chart-container" style="width:525px;">
        <canvas id="schemeProgressChart"></canvas>
        <div class="chart-text ct2" style="margin-top:10%;">Progress by week</div>
      </div>

      <div class="col-md-6 chart-container" style="width:525px;margin-top:8%">
        <canvas id="loanAmountTrendChart"></canvas>
        <div class="chart-text ct2" style="margin-top:10%;">Growth by scheme</div>
      </div>
      <div class="col-md-6 chart-container-large">
        <canvas id="beneficiariesBySchemeChart"></canvas>
        <div class="chart-text ct2">Beneficiaries by scheme</div>
      </div>
      
    </div>

    <!-- Super Admin -->
    <div id="superAdminPanel" class="container mt-5" style="display:none;">
      <h3>Super Admin - Manage Users</h3>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>SN.</th>
            <th style="width:20%;text-align:center;">Full Name</th>
            <th style="width:20%;text-align:center;">Email ID</th>
            <th style="width:20%;text-align:center;">Assigned Role</th>
            <th style="width:10%;text-align:center;">Status</th>
            <th style="width:30%;text-align:center;">Action(s)</th>
          </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div> 

    <script>
      // Check session OR redirect to login
      (async () => {
        const roleMapping = {
          'Super Admin': 1,
          'Client Admin': 2,
          'Data Analyst': 3,
          'Research Lead': 4,
          'Field Supervisor': 5,
          'Data Collection Assistant': 6,
          'Dashboard Developer': 7
        };

        try {
          const res = await fetch('/api/auth/me');
          if (!res.ok) {
            window.location.href = '/login.html';
            return;
          }
          const user = await res.json();
          console.log("Logged in user:", user);
          document.getElementById('userName').textContent = user.full_name || 'User';

          // Show charts for non-Super Admin
          if (user.role !== 'Super Admin') {
            document.getElementById('userCharts').style.display = 'flex';
            // Initialize charts with sample data
            const schemeDistributionCtx = document.getElementById('schemeDistributionChart').getContext('2d');
            new Chart(schemeDistributionCtx, {
              type: 'pie',
              data: {
                labels: ['Micro-credit', 'Ganga Kalyana', 'Airavata'],
                datasets: [{
                  data: [1200, 1000, 739],
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                  borderWidth: 1,
                  borderColor: '#fff'
                }]
              },
              options: {
                title: { display: true, text: 'Scheme Distribution', fontColor: '#fff' },
                legend: { labels: { fontColor: '#fff' } },
                plugins: { legend: { position: 'bottom' } }
              }
            });

            const beneficiariesBySchemeCtx = document.getElementById('beneficiariesBySchemeChart').getContext('2d');
            new Chart(beneficiariesBySchemeCtx, {
              type: 'bar',
              data: {
                labels: ['Micro-credit', 'Ganga Kalyana', 'Airavata'],
                datasets: [{
                  label: 'Beneficiaries',
                  data: [1200, 1000, 739],
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                  borderWidth: 1,
                  borderColor: '#fff'
                }]
              },
              options: {
                title: { display: true, text: 'Beneficiaries by Scheme', fontColor: '#fff' },
                legend: { labels: { fontColor: '#fff' } },
                scales: { y: { beginAtZero: true, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } },
                maintainAspectRatio: false,
                responsive: true
              }
            });

            const completionStatusCtx = document.getElementById('completionStatusChart').getContext('2d');
            new Chart(completionStatusCtx, {
              type: 'pie',
              data: {
                labels: ['Completed', 'In Progress', 'Pending'],
                datasets: [{
                  data: [1500, 1000, 439],
                  backgroundColor: ['#4BC0C0', '#FF9F40', '#9966FF'],
                  borderWidth: 1,
                  borderColor: '#fff'
                }]
              },
              options: {
                title: { display: true, text: 'Completion Status', fontColor: '#fff' },
                legend: { labels: { fontColor: '#fff' } },
                plugins: { legend: { position: 'bottom' } }
              }
            });

            const schemeProgressCtx = document.getElementById('schemeProgressChart').getContext('2d');
            new Chart(schemeProgressCtx, {
              type: 'line',
              data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                  label: 'Progress (%)',
                  data: [25, 50, 75, 100],
                  fill: false,
                  borderColor: '#36A2EB',
                  tension: 0.1,
                  pointBackgroundColor: '#fff',
                  pointBorderColor: '#fff'
                }]
              },
              options: {
                title: { display: true, text: 'Scheme Progress Over Time', fontColor: '#fff' },
                legend: { labels: { fontColor: '#fff' } },
                scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } }
              }
            });

            const loanAmountTrendCtx = document.getElementById('loanAmountTrendChart').getContext('2d');
            new Chart(loanAmountTrendCtx, {
              type: 'bar',
              data: {
                labels: ['Micro-credit', 'Ganga Kalyana', 'Airavata'],
                datasets: [{
                  label: 'Avg Loan Amount (â‚¹)',
                  data: [50000, 75000, 100000],
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                  borderWidth: 1,
                  borderColor: '#fff'
                }]
              },
              options: {
                title: { display: true, text: 'Average Loan Amount by Scheme', fontColor: '#fff' },
                legend: { labels: { fontColor: '#fff' } },
                scales: { y: { beginAtZero: true, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } }
              }
            });
          }

          // Show Super Admin panel
          if (user.role === 'Super Admin') {
            document.getElementById('superAdminPanel').style.display = 'block';

            try {
              const usersRes = await fetch('/api/users/list');
              if (!usersRes.ok) throw new Error('Users list fetch failed');
              const data = await usersRes.json();

              const tbody = document.getElementById('usersTableBody');
              let sn = 0;
              data.users.forEach(u => {
                if (u.role === 'Super Admin') return;

                const tr = document.createElement('tr');
                sn++;
                tr.innerHTML = `
                  <td style="text-align:center">${sn}</td>
                  <td style="text-align:center">${u.full_name}</td>
                  <td style="text-align:center">${u.email}</td>
                  <td>
                    <select class="form-select form-select-sm role-dropdown changeRoleBtn" data-id="${u.id}" data-role="${u.role || 'None'}">
                      <option value="">-- Select Role --</option>
                      <option value="1" ${u.role === 'Super Admin' ? 'selected' : ''}>Super Admin</option>
                      <option value="2" ${u.role === 'Client Admin' ? 'selected' : ''}>Client Admin</option>
                      <option value="3" ${u.role === 'Data Analyst' ? 'selected' : ''}>Data Analyst</option>
                      <option value="4" ${u.role === 'Research Lead' ? 'selected' : ''}>Research Lead</option>
                      <option value="5" ${u.role === 'Field Supervisor' ? 'selected' : ''}>Field Supervisor</option>
                      <option value="6" ${u.role === 'Data Collection Assistant' ? 'selected' : ''}>Data Collection Assistant</option>
                      <option value="7" ${u.role === 'Dashboard Developer' ? 'selected' : ''}>Dashboard Developer</option>
                    </select>
                  </td>
                  <td style="text-align:center">
                    ${u.is_logged_in ? '<span style="color:green;">Online</span>' : '<span style="color:red;">Offline</span>'}
                  </td>
                  <td>
                    <div class="actions-container">
                      <div class="toggle-switch" title="Enable/Disable User">
                        <input type="checkbox" id="toggle-${u.id}" class="statusToggle" data-id="${u.id}" ${u.is_active ? 'checked' : ''}>
                        <label for="toggle-${u.id}"></label>
                      </div>
                      ${u.role === 'Client Admin' ? `
                        <button class="btn btn-secondary client-btn" onclick="window.location.href='/add-view-screen.html'">Add/View Screen</button>
                        <button class="btn btn-secondary client-btn" onclick="window.location.href='/assign-screen.html'">Assign Screen</button>
                      ` : ''}
                    </div>
                  </td>                  
                `;
                tbody.appendChild(tr);
              });

              // Role change dropdown change event
              document.querySelectorAll('.changeRoleBtn').forEach(dropdown => {
                dropdown.addEventListener('change', async (e) => {
                  const userId = e.target.dataset.id;
                  const newRoleId = e.target.value;
                  const newRole = Object.keys(roleMapping).find(key => roleMapping[key] === parseInt(newRoleId));
                  if (confirm(`Are you sure you want to change the role of this user to ${newRole}?`)) {
                    const res = await fetch('/api/users/update-role', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ userId, roleId: newRoleId })
                    });
                    const r = await res.json();
                    alert(r.message);
                    location.reload();
                  } else {
                    e.target.value = dropdown.dataset.role === 'None' ? '' : Object.keys(roleMapping).find(key => roleMapping[key] === parseInt(dropdown.dataset.role));
                  }
                });
              });

              // Active/Deactivate toggle
              document.querySelectorAll('.statusToggle').forEach(toggle => {
                toggle.addEventListener('change', async (e) => {
                  const userId = e.target.dataset.id;
                  const isActive = e.target.checked;
                  if (confirm(`Are you sure you want to ${isActive ? 'activate' : 'deactivate'} this user?`)) {
                    const res = await fetch('/api/users/update-status', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ userId, isActive })
                    });
                    const r = await res.json();
                    alert(r.message);
                  } else {
                    e.target.checked = !isActive;
                  }
                });
              });
            } catch (superAdminErr) {
              console.error('Super Admin panel error:', superAdminErr);
            }
          }
        } catch (err) {
          console.error('Dashboard load error:', err);
          window.location.href = '/login.html';
        }
      })();

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login.html';
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </body>
</html>